<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a1625">
  <title>Chrysalis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;9..144,400;9..144,500&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root{--bg-deep:#1a1625;--bg-card:#252131;--bg-elevated:#2d2839;--bg-input:#1f1b2a;--text-primary:#f4f0f7;--text-secondary:#a89fb5;--text-muted:#6b6279;--accent-primary:#c9a0dc;--accent-secondary:#8ecae6;--accent-warm:#f4a261;--accent-success:#90be6d;--border-subtle:rgba(201,160,220,0.15);--radius-sm:8px;--radius-md:12px;--radius-lg:20px;--radius-xl:28px;--font-display:'Fraunces',Georgia,serif;--font-body:'DM Sans',sans-serif;--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body,#root{height:100%;overflow:hidden}
    body{font-family:var(--font-body);background:var(--bg-deep);color:var(--text-primary);line-height:1.5;-webkit-font-smoothing:antialiased}
    input,textarea,button,select{font-family:inherit;font-size:inherit}
    button{cursor:pointer;border:none;background:none;color:inherit}
    input,textarea{border:none;outline:none;background:none}
    input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(0.8)}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border-subtle);border-radius:4px}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fadeIn 0.3s ease-out}.slide-up{animation:slideUp 0.4s ease-out}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const{useState,useEffect,useRef}=React;
    const gid=()=>Math.random().toString(36).substr(2,9);
    const fmtDate=d=>new Date(d).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const fmtDateFull=d=>new Date(d).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    const fmtDateShort=d=>new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const fmtDateInput=d=>{const x=new Date(d);return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`};
    const daysBetween=(d1,d2)=>Math.ceil(Math.abs(new Date(d2)-new Date(d1))/864e5);
    const dateKey=d=>{const x=new Date(d);return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`};
    const sameDay=(d1,d2)=>dateKey(d1)===dateKey(d2);

    const STORE='chrysalis_v2',PIN_KEY='chrysalis_pin';
    const defData={photos:[],journals:[],medications:[],medLogs:[],milestones:[],categories:['Face','Body','Hair','Other'],customTags:[{id:'mood',name:'Mood',emoji:'ðŸ˜Š',color:'#c9a0dc',scale:5},{id:'energy',name:'Energy',emoji:'âš¡',color:'#f4a261',scale:5}],tagLogs:[],reminders:[]};
    const load=()=>{try{const s=localStorage.getItem(STORE);if(s)return{...defData,...JSON.parse(s)}}catch{}return defData};
    const save=d=>{try{localStorage.setItem(STORE,JSON.stringify(d))}catch{}};

    const Icons={
      Calendar:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
      Camera:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
      Pill:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.5 20.5L3.5 13.5a4.95 4.95 0 1 1 7-7l7 7a4.95 4.95 0 0 1-7 7z"/><line x1="8.5" y1="8.5" x2="15.5" y2="15.5"/></svg>,
      Chart:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
      Settings:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
      Plus:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
      X:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      ChevronLeft:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>,
      ChevronRight:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,
      Grid:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
      Lock:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
      Trash:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
      Check:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
      Download:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
      Upload:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
      Edit:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
      ZoomIn:()=><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
    };

    // Stealth Mode
    const Stealth=({onExit})=>{
      const[time,setTime]=useState(new Date());
      const[taps,setTaps]=useState(0);
      useEffect(()=>{const i=setInterval(()=>setTime(new Date()),1000);return()=>clearInterval(i)},[]);
      const trains=[{line:'Blue Line',dest:'Downtown',time:'3 min'},{line:'Red Line',dest:'Airport',time:'7 min'},{line:'Green Line',dest:'University',time:'12 min'}];
      const tap=()=>{setTaps(p=>{if(p>=2){onExit();return 0}setTimeout(()=>setTaps(0),1500);return p+1})};
      return(
        <div style={{height:'100%',background:'#1a1a2e',padding:20,paddingTop:'calc(20px + var(--safe-top))'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:30}}>
            <div><div style={{fontSize:12,color:'#666',marginBottom:4}}>METRO TRANSIT</div><div style={{fontSize:28,fontWeight:600}}>{time.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div>
            <button onClick={tap} style={{padding:'8px 16px',background:'#2a2a4a',borderRadius:8,fontSize:14}}>Refresh</button>
          </div>
          <div style={{fontSize:12,color:'#666',marginBottom:12}}>UPCOMING DEPARTURES</div>
          {trains.map((t,i)=><div key={i} style={{display:'flex',justifyContent:'space-between',padding:16,background:'#2a2a4a',borderRadius:8,marginBottom:8}}><div><div style={{fontWeight:500}}>{t.line}</div><div style={{fontSize:13,color:'#888'}}>{t.dest}</div></div><div style={{fontSize:18,fontWeight:600,color:i===0?'#4ade80':'#fff'}}>{t.time}</div></div>)}
          <div style={{fontSize:11,color:'#555',textAlign:'center',marginTop:40}}>Triple-tap refresh to access app</div>
        </div>
      );
    };

    // PIN Lock
    const PinLock=({onUnlock,isSetup,onComplete})=>{
      const[pin,setPin]=useState('');
      const[confirm,setConfirm]=useState('');
      const[step,setStep]=useState(isSetup?'create':'enter');
      const[error,setError]=useState('');
      const digit=d=>{
        if(step==='create'&&pin.length<4){const n=pin+d;setPin(n);if(n.length===4)setTimeout(()=>setStep('confirm'),300)}
        else if(step==='confirm'&&confirm.length<4){const n=confirm+d;setConfirm(n);if(n.length===4){if(n===pin){localStorage.setItem(PIN_KEY,pin);onComplete()}else{setError('PINs do not match');setTimeout(()=>{setPin('');setConfirm('');setStep('create');setError('')},1500)}}}
        else if(step==='enter'&&pin.length<4){const n=pin+d;setPin(n);if(n.length===4){if(n===localStorage.getItem(PIN_KEY))onUnlock();else{setError('Incorrect PIN');setTimeout(()=>{setPin('');setError('')},1000)}}}
      };
      const curr=step==='confirm'?confirm:pin;
      return(
        <div style={{height:'100%',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:20,background:'linear-gradient(180deg,var(--bg-deep),#1f1a2e)'}}>
          <div style={{fontSize:48,marginBottom:20}}>ðŸ¦‹</div>
          <h2 style={{fontFamily:'var(--font-display)',fontSize:24,fontWeight:400,marginBottom:8}}>{step==='create'?'Create PIN':step==='confirm'?'Confirm PIN':'Welcome Back'}</h2>
          <p style={{color:error?'#e76f51':'var(--text-secondary)',fontSize:14,marginBottom:40,height:20}}>{error||(step==='enter'?'Enter your PIN':'Choose a 4-digit PIN')}</p>
          <div style={{display:'flex',gap:16,marginBottom:48}}>{[0,1,2,3].map(i=><div key={i} style={{width:16,height:16,borderRadius:'50%',background:i<curr.length?'var(--accent-primary)':'var(--bg-elevated)'}}/>)}</div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(3, 1fr)',gap:16,maxWidth:280}}>
            {[1,2,3,4,5,6,7,8,9,'',0,'âŒ«'].map((d,i)=><button key={i} onClick={()=>d==='âŒ«'?(step==='confirm'?setConfirm(p=>p.slice(0,-1)):setPin(p=>p.slice(0,-1))):d!==''&&digit(String(d))} style={{width:72,height:72,borderRadius:'50%',background:d===''?'transparent':'var(--bg-elevated)',fontSize:d==='âŒ«'?20:28,fontWeight:300,opacity:d===''?0:1}}>{d}</button>)}
          </div>
        </div>
      );
    };

    // Modal
    const Modal=({isOpen,onClose,title,children,full})=>!isOpen?null:(
      <div style={{position:'fixed',inset:0,background:full?'var(--bg-deep)':'rgba(0,0,0,0.7)',display:'flex',alignItems:full?'stretch':'flex-end',justifyContent:'center',zIndex:1000}} onClick={!full?onClose:undefined}>
        <div style={{width:'100%',maxWidth:full?'100%':500,height:full?'100%':'auto',maxHeight:full?'100%':'90vh',background:'var(--bg-card)',borderRadius:full?0:'var(--radius-xl) var(--radius-xl) 0 0',overflow:'hidden',display:'flex',flexDirection:'column'}} onClick={e=>e.stopPropagation()}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'16px 20px',paddingTop:full?'calc(16px + var(--safe-top))':16,borderBottom:'1px solid var(--border-subtle)',flexShrink:0}}>
            <h3 style={{fontFamily:'var(--font-display)',fontSize:18,fontWeight:500}}>{title}</h3>
            <button onClick={onClose} style={{opacity:0.6,padding:4}}><Icons.X/></button>
          </div>
          <div style={{flex:1,overflow:'auto',padding:full?0:20}}>{children}</div>
        </div>
      </div>
    );

    // Photo Viewer
    const PhotoViewer=({photos,initial,onClose,onEdit})=>{
      const[idx,setIdx]=useState(initial);
      const[scale,setScale]=useState(1);
      const[pos,setPos]=useState({x:0,y:0});
      const lastTouch=useRef(null);
      const lastDist=useRef(null);
      const photo=photos[idx];
      const touchStart=e=>{if(e.touches.length===2){lastDist.current=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY)}else if(scale>1){lastTouch.current={x:e.touches[0].clientX,y:e.touches[0].clientY}}};
      const touchMove=e=>{if(e.touches.length===2&&lastDist.current){const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);setScale(s=>Math.min(5,Math.max(1,s*(d/lastDist.current))));lastDist.current=d}else if(e.touches.length===1&&lastTouch.current&&scale>1){setPos(p=>({x:p.x+e.touches[0].clientX-lastTouch.current.x,y:p.y+e.touches[0].clientY-lastTouch.current.y}));lastTouch.current={x:e.touches[0].clientX,y:e.touches[0].clientY}}};
      const touchEnd=()=>{lastDist.current=null;lastTouch.current=null;if(scale<=1)setPos({x:0,y:0})};
      const next=()=>{if(idx<photos.length-1){setIdx(idx+1);setScale(1);setPos({x:0,y:0})}};
      const prev=()=>{if(idx>0){setIdx(idx-1);setScale(1);setPos({x:0,y:0})}};
      return(
        <div style={{position:'fixed',inset:0,background:'#000',zIndex:1100,display:'flex',flexDirection:'column'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 16px',paddingTop:'calc(12px + var(--safe-top))',background:'rgba(0,0,0,0.5)',zIndex:10}}>
            <button onClick={onClose} style={{padding:8}}><Icons.X/></button>
            <span style={{fontSize:14}}>{idx+1} / {photos.length}</span>
            <button onClick={()=>setScale(s=>s===1?2:1)} style={{padding:8}}><Icons.ZoomIn/></button>
          </div>
          <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',overflow:'hidden',position:'relative'}} onTouchStart={touchStart} onTouchMove={touchMove} onTouchEnd={touchEnd}>
            {idx>0&&scale===1&&<button onClick={prev} style={{position:'absolute',left:8,zIndex:10,padding:12,background:'rgba(0,0,0,0.5)',borderRadius:'50%'}}><Icons.ChevronLeft/></button>}
            <img src={photo.data} style={{maxWidth:'100%',maxHeight:'100%',transform:`scale(${scale}) translate(${pos.x/scale}px,${pos.y/scale}px)`,transition:lastTouch.current?'none':'transform 0.2s'}} draggable={false}/>
            {idx<photos.length-1&&scale===1&&<button onClick={next} style={{position:'absolute',right:8,zIndex:10,padding:12,background:'rgba(0,0,0,0.5)',borderRadius:'50%'}}><Icons.ChevronRight/></button>}
          </div>
          <div style={{padding:'12px 16px',paddingBottom:'calc(12px + var(--safe-bottom))',background:'rgba(0,0,0,0.5)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div><div style={{fontSize:14}}>{photo.category}</div><div style={{fontSize:12,color:'var(--text-muted)'}}>{fmtDateFull(photo.date)}</div></div>
            <button onClick={()=>onEdit(photo)} style={{padding:'8px 16px',background:'var(--bg-card)',borderRadius:'var(--radius-md)',display:'flex',alignItems:'center',gap:6}}><Icons.Edit/> Edit</button>
          </div>
        </div>
      );
    };

    // Timeline Grid
    const TimelineGrid=({photos})=>{
      const[count,setCount]=useState(4);
      const[selected,setSelected]=useState([]);
      const[viewing,setViewing]=useState(null);
      const sorted=[...photos].sort((a,b)=>new Date(a.date)-new Date(b.date));
      const toggle=p=>{if(selected.find(s=>s.id===p.id))setSelected(selected.filter(s=>s.id!==p.id));else if(selected.length<count)setSelected([...selected,p])};
      const grid=selected.length>0?selected.sort((a,b)=>new Date(a.date)-new Date(b.date)):sorted.slice(0,count);
      const cols=count<=4?2:count<=9?3:4;
      return(
        <div style={{padding:20}}>
          <div style={{marginBottom:20}}><div style={{fontSize:12,color:'var(--text-muted)',marginBottom:8}}>GRID SIZE</div><div style={{display:'flex',gap:8,flexWrap:'wrap'}}>{[2,4,6,9,12,16].map(n=><button key={n} onClick={()=>{setCount(n);setSelected([])}} style={{padding:'8px 16px',borderRadius:'var(--radius-md)',background:count===n?'var(--accent-primary)':'var(--bg-input)',color:count===n?'var(--bg-deep)':'var(--text-primary)',fontSize:14}}>{n}</button>)}</div></div>
          <div style={{display:'grid',gridTemplateColumns:`repeat(${cols}, 1fr)`,gap:4,marginBottom:20}}>{grid.map(p=><div key={p.id} style={{aspectRatio:'1',position:'relative',borderRadius:'var(--radius-sm)',overflow:'hidden'}}><img src={p.data} style={{width:'100%',height:'100%',objectFit:'cover'}}/><div style={{position:'absolute',bottom:4,left:4,padding:'2px 6px',background:'rgba(0,0,0,0.7)',borderRadius:4,fontSize:10}}>{fmtDateShort(p.date)}</div></div>)}</div>
          <div style={{fontSize:12,color:'var(--text-muted)',marginBottom:8}}>SELECT PHOTOS ({selected.length}/{count})</div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(4, 1fr)',gap:4,maxHeight:200,overflowY:'auto'}}>{sorted.map(p=><button key={p.id} onClick={()=>toggle(p)} style={{aspectRatio:'1',borderRadius:4,overflow:'hidden',opacity:selected.find(s=>s.id===p.id)?1:0.5,border:selected.find(s=>s.id===p.id)?'2px solid var(--accent-primary)':'none'}}><img src={p.data} style={{width:'100%',height:'100%',objectFit:'cover'}}/></button>)}</div>
          {selected.length>0&&<button onClick={()=>setViewing(0)} style={{width:'100%',marginTop:16,padding:14,background:'var(--accent-primary)',borderRadius:'var(--radius-md)',color:'var(--bg-deep)',fontWeight:500}}>View Slideshow</button>}
          {viewing!==null&&<PhotoViewer photos={selected.sort((a,b)=>new Date(a.date)-new Date(b.date))} initial={viewing} onClose={()=>setViewing(null)} onEdit={()=>{}}/>}
        </div>
      );
    };

    // Tracking Chart
    const TrackingChart=({data})=>{
      const[enabled,setEnabled]=useState(data.customTags.map(t=>t.id));
      const[days,setDays]=useState(30);
      const end=new Date(),start=new Date(end.getTime()-days*864e5);
      const range=[];for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1))range.push(dateKey(new Date(d)));
      const toggle=id=>enabled.includes(id)?setEnabled(enabled.filter(t=>t!==id)):setEnabled([...enabled,id]);
      const getVal=(tagId,dk)=>{const l=data.tagLogs.find(x=>x.tagId===tagId&&dateKey(x.date)===dk);return l?l.value:null};
      return(
        <div className="fade-in" style={{padding:20}}>
          <h2 style={{fontFamily:'var(--font-display)',fontSize:20,fontWeight:500,marginBottom:20}}>Tracking</h2>
          <div style={{display:'flex',gap:8,marginBottom:16,overflowX:'auto',paddingBottom:8}}>{[7,14,30,60,90].map(d=><button key={d} onClick={()=>setDays(d)} style={{padding:'6px 12px',borderRadius:16,background:days===d?'var(--accent-primary)':'var(--bg-card)',color:days===d?'var(--bg-deep)':'var(--text-primary)',fontSize:13,whiteSpace:'nowrap'}}>{d}d</button>)}</div>
          <div style={{display:'flex',gap:8,marginBottom:20,flexWrap:'wrap'}}>{data.customTags.map(t=><button key={t.id} onClick={()=>toggle(t.id)} style={{padding:'6px 12px',borderRadius:16,background:enabled.includes(t.id)?t.color+'30':'var(--bg-card)',border:`2px solid ${enabled.includes(t.id)?t.color:'transparent'}`,fontSize:13,display:'flex',alignItems:'center',gap:4}}><span>{t.emoji}</span> {t.name}</button>)}</div>
          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:16,overflowX:'auto'}}>
            <svg width={Math.max(range.length*20,300)} height={200} style={{display:'block'}}>
              {[0,0.25,0.5,0.75,1].map((y,i)=><line key={i} x1={30} y1={20+(1-y)*150} x2={range.length*20+30} y2={20+(1-y)*150} stroke="var(--border-subtle)" strokeWidth={1}/>)}
              {data.customTags.filter(t=>enabled.includes(t.id)).map(tag=>{
                const pts=range.map((dk,i)=>{const v=getVal(tag.id,dk);return v?{x:30+i*20,y:20+(1-v/tag.scale)*150}:null}).filter(Boolean);
                if(pts.length<2)return null;
                return<g key={tag.id}><path d={pts.map((p,i)=>`${i===0?'M':'L'} ${p.x} ${p.y}`).join(' ')} fill="none" stroke={tag.color} strokeWidth={2}/>{pts.map((p,i)=><circle key={i} cx={p.x} cy={p.y} r={4} fill={tag.color}/>)}</g>;
              })}
              {range.filter((_,i)=>i%Math.ceil(range.length/7)===0).map(dk=><text key={dk} x={30+range.indexOf(dk)*20} y={190} fill="var(--text-muted)" fontSize={10} textAnchor="middle">{new Date(dk).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</text>)}
            </svg>
          </div>
          {data.customTags.length===0&&<div style={{textAlign:'center',padding:40,color:'var(--text-muted)'}}><p>No tags yet. Add custom tags in Calendar â†’ Day view.</p></div>}
        </div>
      );
    };

    // Calendar View
    const CalendarView=({data,onDateSelect})=>{
      const[month,setMonth]=useState(new Date());
      const getDays=d=>{const y=d.getFullYear(),m=d.getMonth(),first=new Date(y,m,1),last=new Date(y,m+1,0),days=[];for(let i=0;i<first.getDay();i++)days.push(null);for(let i=1;i<=last.getDate();i++)days.push(new Date(y,m,i));return days};
      const getData=d=>{if(!d)return{};const k=dateKey(d);return{photos:data.photos.filter(p=>dateKey(p.date)===k).length,journals:data.journals.filter(j=>dateKey(j.date)===k).length,meds:data.medLogs.filter(m=>dateKey(m.date)===k).length,tags:data.tagLogs.filter(t=>dateKey(t.date)===k).length}};
      const days=getDays(month),today=new Date();
      return(
        <div className="fade-in">
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}>
            <button onClick={()=>setMonth(new Date(month.getFullYear(),month.getMonth()-1))} style={{padding:8}}><Icons.ChevronLeft/></button>
            <h2 style={{fontFamily:'var(--font-display)',fontSize:20,fontWeight:500}}>{month.toLocaleDateString('en-US',{month:'long',year:'numeric'})}</h2>
            <button onClick={()=>setMonth(new Date(month.getFullYear(),month.getMonth()+1))} style={{padding:8}}><Icons.ChevronRight/></button>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(7, 1fr)',gap:4,marginBottom:8}}>{['S','M','T','W','T','F','S'].map((d,i)=><div key={i} style={{textAlign:'center',fontSize:12,color:'var(--text-muted)',padding:'8px 0'}}>{d}</div>)}</div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(7, 1fr)',gap:4}}>
            {days.map((d,i)=>{if(!d)return<div key={i}/>;const dd=getData(d),isToday=sameDay(d,today),hasData=dd.photos||dd.journals||dd.meds||dd.tags;
              return<button key={i} onClick={()=>onDateSelect(d)} style={{aspectRatio:'1',borderRadius:'var(--radius-sm)',background:isToday?'var(--bg-elevated)':'transparent',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center'}}>
                <span style={{fontSize:14,fontWeight:isToday?600:400}}>{d.getDate()}</span>
                {hasData&&<div style={{display:'flex',gap:2,marginTop:2}}>{dd.photos>0&&<div style={{width:4,height:4,borderRadius:'50%',background:'var(--accent-secondary)'}}/>}{dd.journals>0&&<div style={{width:4,height:4,borderRadius:'50%',background:'var(--accent-warm)'}}/>}{dd.meds>0&&<div style={{width:4,height:4,borderRadius:'50%',background:'var(--accent-success)'}}/>}{dd.tags>0&&<div style={{width:4,height:4,borderRadius:'50%',background:'var(--accent-primary)'}}/>}</div>}
              </button>;
            })}
          </div>
          <div style={{display:'flex',gap:12,justifyContent:'center',marginTop:20,fontSize:11,color:'var(--text-muted)',flexWrap:'wrap'}}><span style={{display:'flex',alignItems:'center',gap:4}}><div style={{width:8,height:8,borderRadius:'50%',background:'var(--accent-secondary)'}}/> Photos</span><span style={{display:'flex',alignItems:'center',gap:4}}><div style={{width:8,height:8,borderRadius:'50%',background:'var(--accent-warm)'}}/> Journal</span><span style={{display:'flex',alignItems:'center',gap:4}}><div style={{width:8,height:8,borderRadius:'50%',background:'var(--accent-success)'}}/> Meds</span><span style={{display:'flex',alignItems:'center',gap:4}}><div style={{width:8,height:8,borderRadius:'50%',background:'var(--accent-primary)'}}/> Tags</span></div>
        </div>
      );
    };

    // Add Tag Form
    const AddTagForm=({data,setData,onClose})=>{
      const[name,setName]=useState('');
      const[emoji,setEmoji]=useState('ðŸ“Š');
      const[scale,setScale]=useState(5);
      const[color,setColor]=useState('#c9a0dc');
      const colors=['#c9a0dc','#8ecae6','#f4a261','#90be6d','#e76f51','#ff6b6b','#4ecdc4','#ffe66d'];
      const emojis=['ðŸ“Š','âš¡','ðŸ˜´','ðŸ’ª','ðŸ”¥','ðŸ’œ','ðŸŒ™','â˜€ï¸','ðŸ’§','ðŸŽ¯','â¤ï¸','ðŸ§ '];
      const add=()=>{if(!name.trim())return;setData(p=>({...p,customTags:[...p.customTags,{id:gid(),name,emoji,scale,color}]}));onClose()};
      return(
        <div style={{display:'flex',flexDirection:'column',gap:16}}>
          <div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>NAME</label><input type="text" value={name} onChange={e=>setName(e.target.value)} placeholder="e.g., Libido" style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',color:'var(--text-primary)'}}/></div>
          <div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>EMOJI</label><div style={{display:'flex',gap:8,flexWrap:'wrap'}}>{emojis.map(e=><button key={e} onClick={()=>setEmoji(e)} style={{padding:8,fontSize:20,borderRadius:'var(--radius-md)',background:emoji===e?'var(--bg-elevated)':'transparent',border:emoji===e?'2px solid var(--accent-primary)':'2px solid transparent'}}>{e}</button>)}</div></div>
          <div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>SCALE</label><div style={{display:'flex',gap:8}}>{[3,5,7,10].map(s=><button key={s} onClick={()=>setScale(s)} style={{flex:1,padding:10,borderRadius:'var(--radius-md)',background:scale===s?'var(--accent-primary)':'var(--bg-input)',color:scale===s?'var(--bg-deep)':'var(--text-primary)'}}>{s}</button>)}</div></div>
          <div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>COLOR</label><div style={{display:'flex',gap:8,flexWrap:'wrap'}}>{colors.map(c=><button key={c} onClick={()=>setColor(c)} style={{width:36,height:36,borderRadius:'50%',background:c,border:color===c?'3px solid var(--text-primary)':'none'}}/>)}</div></div>
          <button onClick={add} style={{width:'100%',padding:14,background:'var(--accent-primary)',borderRadius:'var(--radius-md)',color:'var(--bg-deep)',fontWeight:500,marginTop:8}}>Add Tag</button>
        </div>
      );
    };

    // Day Detail
    const DayDetail=({date,data,setData,onClose})=>{
      const dk=dateKey(date);
      const dayPhotos=data.photos.filter(p=>dateKey(p.date)===dk);
      const dayJournals=data.journals.filter(j=>dateKey(j.date)===dk);
      const dayMeds=data.medLogs.filter(m=>dateKey(m.date)===dk);
      const dayTags=data.tagLogs.filter(t=>dateKey(t.date)===dk);
      const[journalText,setJournalText]=useState('');
      const[showLogMed,setShowLogMed]=useState(false);
      const[showAddTag,setShowAddTag]=useState(false);
      const[viewing,setViewing]=useState(null);
      const fileRef=useRef(null);

      const addJournal=()=>{if(!journalText.trim())return;setData(p=>({...p,journals:[...p.journals,{id:gid(),date:date.toISOString(),text:journalText}]}));setJournalText('')};
      const setTagVal=(tagId,value)=>setData(p=>({...p,tagLogs:[...p.tagLogs.filter(t=>!(t.tagId===tagId&&dateKey(t.date)===dk)),{id:gid(),tagId,value,date:date.toISOString()}]}));
      const getTagVal=tagId=>{const l=dayTags.find(t=>t.tagId===tagId);return l?l.value:null};
      const handleUpload=e=>{Array.from(e.target.files).forEach(f=>{const r=new FileReader();r.onload=ev=>setData(p=>({...p,photos:[...p.photos,{id:gid(),data:ev.target.result,category:'Other',date:date.toISOString()}]}));r.readAsDataURL(f)})};
      const logMed=med=>{setData(p=>({...p,medLogs:[...p.medLogs,{id:gid(),medicationId:med.id,dose:med.dose,site:'',notes:'',date:date.toISOString()}]}));setShowLogMed(false)};

      return(
        <div className="slide-up">
          <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:24}}><button onClick={onClose} style={{opacity:0.6}}><Icons.ChevronLeft/></button><h2 style={{fontFamily:'var(--font-display)',fontSize:20,fontWeight:500}}>{fmtDateFull(date)}</h2></div>

          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:20,marginBottom:16}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}><div style={{fontSize:12,color:'var(--text-muted)'}}>TRACK</div><button onClick={()=>setShowAddTag(true)} style={{fontSize:12,color:'var(--accent-primary)'}}>+ Add Tag</button></div>
            {data.customTags.map(tag=>(
              <div key={tag.id} style={{marginBottom:16}}>
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}><span>{tag.emoji}</span><span style={{fontSize:14}}>{tag.name}</span></div>
                <div style={{display:'flex',gap:8}}>{Array.from({length:tag.scale},(_,i)=>i+1).map(v=><button key={v} onClick={()=>setTagVal(tag.id,v)} style={{flex:1,padding:'10px 0',borderRadius:'var(--radius-md)',background:getTagVal(tag.id)===v?tag.color:'var(--bg-input)',color:getTagVal(tag.id)===v?'var(--bg-deep)':'var(--text-primary)',fontWeight:500}}>{v}</button>)}</div>
              </div>
            ))}
          </div>

          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:20,marginBottom:16}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}><div style={{fontSize:12,color:'var(--text-muted)'}}>PHOTOS</div><button onClick={()=>fileRef.current?.click()} style={{fontSize:12,color:'var(--accent-primary)'}}>+ Add</button><input ref={fileRef} type="file" accept="image/*" multiple onChange={handleUpload} style={{display:'none'}}/></div>
            {dayPhotos.length>0?<div style={{display:'grid',gridTemplateColumns:'repeat(3, 1fr)',gap:8}}>{dayPhotos.map((p,i)=><button key={p.id} onClick={()=>setViewing({photos:dayPhotos,idx:i})} style={{aspectRatio:'1',borderRadius:'var(--radius-md)',overflow:'hidden'}}><img src={p.data} style={{width:'100%',height:'100%',objectFit:'cover'}}/></button>)}</div>:<div style={{textAlign:'center',padding:20,color:'var(--text-muted)',fontSize:14}}>No photos</div>}
          </div>

          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:20,marginBottom:16}}>
            <div style={{fontSize:12,color:'var(--text-muted)',marginBottom:12}}>JOURNAL</div>
            {dayJournals.map(j=><div key={j.id} style={{padding:12,background:'var(--bg-input)',borderRadius:'var(--radius-md)',marginBottom:8,fontSize:14,lineHeight:1.6}}>{j.text}</div>)}
            <div style={{display:'flex',gap:8}}><textarea value={journalText} onChange={e=>setJournalText(e.target.value)} placeholder="Write something..." style={{flex:1,background:'var(--bg-input)',borderRadius:'var(--radius-md)',padding:12,fontSize:14,resize:'none',minHeight:60,color:'var(--text-primary)'}}/><button onClick={addJournal} style={{width:44,background:'var(--accent-primary)',borderRadius:'var(--radius-md)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--bg-deep)'}}><Icons.Plus/></button></div>
          </div>

          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:20,marginBottom:16}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}><div style={{fontSize:12,color:'var(--text-muted)'}}>MEDICATIONS</div>{data.medications.length>0&&<button onClick={()=>setShowLogMed(true)} style={{fontSize:12,color:'var(--accent-primary)'}}>+ Log</button>}</div>
            {dayMeds.length>0?dayMeds.map(l=>{const m=data.medications.find(x=>x.id===l.medicationId);return<div key={l.id} style={{display:'flex',alignItems:'center',gap:12,padding:12,background:'var(--bg-input)',borderRadius:'var(--radius-md)',marginBottom:8}}><div style={{width:36,height:36,borderRadius:'50%',background:'var(--accent-success)',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--bg-deep)'}}><Icons.Check/></div><div><div style={{fontWeight:500}}>{m?.name||'Unknown'}</div><div style={{fontSize:12,color:'var(--text-muted)'}}>{l.dose}{l.site&&` â€¢ ${l.site}`}</div></div></div>}):<div style={{textAlign:'center',padding:20,color:'var(--text-muted)',fontSize:14}}>{data.medications.length?'No doses logged':'Add meds in Meds tab'}</div>}
          </div>

          <Modal isOpen={showLogMed} onClose={()=>setShowLogMed(false)} title="Log Medication"><div style={{display:'flex',flexDirection:'column',gap:12}}>{data.medications.map(m=><button key={m.id} onClick={()=>logMed(m)} style={{padding:16,background:'var(--bg-input)',borderRadius:'var(--radius-md)',textAlign:'left'}}><div style={{fontWeight:500}}>{m.name}</div><div style={{fontSize:13,color:'var(--text-muted)'}}>{m.dose} â€¢ {m.frequency}</div></button>)}</div></Modal>
          <Modal isOpen={showAddTag} onClose={()=>setShowAddTag(false)} title="Add Custom Tag"><AddTagForm data={data} setData={setData} onClose={()=>setShowAddTag(false)}/></Modal>
          {viewing&&<PhotoViewer photos={viewing.photos} initial={viewing.idx} onClose={()=>setViewing(null)} onEdit={()=>{}}/>}
        </div>
      );
    };

    // Photos Tab
    const PhotosTab=({data,setData})=>{
      const[cat,setCat]=useState('All');
      const[showCamera,setShowCamera]=useState(false);
      const[showTimeline,setShowTimeline]=useState(false);
      const[viewing,setViewing]=useState(null);
      const[editing,setEditing]=useState(null);
      const[showAddCat,setShowAddCat]=useState(false);
      const[newCat,setNewCat]=useState('');
      const[camCat,setCamCat]=useState('Face');
      const[ghost,setGhost]=useState(null);
      const[ghostOn,setGhostOn]=useState(true);
      const[stream,setStream]=useState(null);
      const fileRef=useRef(null),vidRef=useRef(null);
      const cats=['All',...data.categories];
      const photos=(cat==='All'?data.photos:data.photos.filter(p=>p.category===cat)).sort((a,b)=>new Date(b.date)-new Date(a.date));

      const updateGhost=c=>{if(!ghostOn)return setGhost(null);const cp=data.photos.filter(p=>p.category===c);setGhost(cp.length?cp.sort((a,b)=>new Date(b.date)-new Date(a.date))[0].data:null)};
      const startCam=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:1280,height:1280}});setStream(s);setShowCamera(true);updateGhost(camCat)}catch{alert('Camera denied')}};
      useEffect(()=>{if(stream&&vidRef.current)vidRef.current.srcObject=stream},[stream,showCamera]);
      const stopCam=()=>{if(stream)stream.getTracks().forEach(t=>t.stop());setStream(null);setShowCamera(false)};
      const capture=()=>{if(!vidRef.current)return;const c=document.createElement('canvas');c.width=vidRef.current.videoWidth;c.height=vidRef.current.videoHeight;c.getContext('2d').drawImage(vidRef.current,0,0);setData(p=>({...p,photos:[...p.photos,{id:gid(),data:c.toDataURL('image/jpeg',0.8),category:camCat,date:new Date().toISOString()}]}));stopCam()};
      const handleUpload=e=>{Array.from(e.target.files).forEach(f=>{const r=new FileReader();r.onload=ev=>setData(p=>({...p,photos:[...p.photos,{id:gid(),data:ev.target.result,category:cat==='All'?'Other':cat,date:new Date().toISOString()}]}));r.readAsDataURL(f)})};
      const addCat=()=>{if(!newCat.trim()||data.categories.includes(newCat.trim()))return;setData(p=>({...p,categories:[...p.categories,newCat.trim()]}));setNewCat('');setShowAddCat(false)};
      const updatePhoto=(id,u)=>setData(p=>({...p,photos:p.photos.map(ph=>ph.id===id?{...ph,...u}:ph)}));
      const delPhoto=id=>{if(confirm('Delete photo?')){setData(p=>({...p,photos:p.photos.filter(x=>x.id!==id)}));setViewing(null);setEditing(null)}};

      return(
        <div className="fade-in">
          <div style={{display:'flex',gap:8,overflowX:'auto',paddingBottom:16,marginBottom:16}}>{cats.map(c=><button key={c} onClick={()=>setCat(c)} style={{padding:'8px 16px',borderRadius:20,background:cat===c?'var(--accent-primary)':'var(--bg-card)',color:cat===c?'var(--bg-deep)':'var(--text-primary)',fontSize:14,fontWeight:500,whiteSpace:'nowrap'}}>{c}</button>)}<button onClick={()=>setShowAddCat(true)} style={{padding:'8px 16px',borderRadius:20,background:'var(--bg-card)',border:'1px dashed var(--border-subtle)',fontSize:14,color:'var(--text-muted)',whiteSpace:'nowrap'}}>+ Add</button></div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(3, 1fr)',gap:8,marginBottom:24}}>
            <button onClick={startCam} style={{padding:'12px 8px',background:'var(--accent-primary)',borderRadius:'var(--radius-md)',color:'var(--bg-deep)',display:'flex',flexDirection:'column',alignItems:'center',gap:4}}><Icons.Camera/><span style={{fontSize:11}}>Camera</span></button>
            <button onClick={()=>fileRef.current?.click()} style={{padding:'12px 8px',background:'var(--bg-card)',borderRadius:'var(--radius-md)',display:'flex',flexDirection:'column',alignItems:'center',gap:4}}><Icons.Upload/><span style={{fontSize:11}}>Upload</span></button>
            <button onClick={()=>setShowTimeline(true)} style={{padding:'12px 8px',background:'var(--bg-card)',borderRadius:'var(--radius-md)',display:'flex',flexDirection:'column',alignItems:'center',gap:4}}><Icons.Grid/><span style={{fontSize:11}}>Timeline</span></button>
            <input ref={fileRef} type="file" accept="image/*" multiple onChange={handleUpload} style={{display:'none'}}/>
          </div>
          {photos.length===0?<div style={{textAlign:'center',padding:60,color:'var(--text-muted)'}}><div style={{fontSize:48,marginBottom:16}}>ðŸ“¸</div><p>No photos yet</p></div>:<div style={{display:'grid',gridTemplateColumns:'repeat(3, 1fr)',gap:4}}>{photos.map((p,i)=><button key={p.id} onClick={()=>setViewing({photos,idx:i})} style={{aspectRatio:'1',borderRadius:'var(--radius-sm)',overflow:'hidden',position:'relative'}}><img src={p.data} style={{width:'100%',height:'100%',objectFit:'cover'}}/><div style={{position:'absolute',bottom:4,left:4,padding:'2px 6px',background:'rgba(0,0,0,0.6)',borderRadius:4,fontSize:10}}>{fmtDateShort(p.date)}</div></button>)}</div>}

          {showCamera&&<div style={{position:'fixed',inset:0,background:'#000',zIndex:1000,display:'flex',flexDirection:'column'}}><div style={{flex:1,position:'relative'}}><video ref={vidRef} autoPlay playsInline muted style={{width:'100%',height:'100%',objectFit:'cover'}}/>{ghost&&ghostOn&&<img src={ghost} style={{position:'absolute',inset:0,width:'100%',height:'100%',objectFit:'cover',opacity:0.3,pointerEvents:'none'}}/>}</div><div style={{padding:20,paddingBottom:'calc(20px + var(--safe-bottom))',background:'var(--bg-deep)'}}><div style={{display:'flex',gap:8,justifyContent:'center',marginBottom:20,flexWrap:'wrap'}}>{data.categories.map(c=><button key={c} onClick={()=>{setCamCat(c);updateGhost(c)}} style={{padding:'6px 14px',borderRadius:16,background:camCat===c?'var(--accent-primary)':'var(--bg-card)',color:camCat===c?'var(--bg-deep)':'var(--text-primary)',fontSize:13}}>{c}</button>)}</div><div style={{display:'flex',alignItems:'center',justifyContent:'space-around'}}><button onClick={stopCam} style={{padding:12}}><Icons.X/></button><button onClick={capture} style={{width:72,height:72,borderRadius:'50%',background:'var(--accent-primary)',border:'4px solid var(--text-primary)'}}/><button onClick={()=>{const next=!ghostOn;setGhostOn(next);if(next)updateGhost(camCat);else setGhost(null)}} style={{padding:12,opacity:ghostOn?1:0.3,fontSize:24}}>ðŸ‘»</button></div></div></div>}

          {viewing&&!editing&&<PhotoViewer photos={viewing.photos} initial={viewing.idx} onClose={()=>setViewing(null)} onEdit={p=>{setEditing(p);setViewing(null)}}/>}

          <Modal isOpen={!!editing} onClose={()=>setEditing(null)} title="Edit Photo">{editing&&<div style={{display:'flex',flexDirection:'column',gap:16}}><img src={editing.data} style={{width:'100%',borderRadius:'var(--radius-md)'}}/><div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>DATE</label><input type="date" value={fmtDateInput(editing.date)} onChange={e=>{updatePhoto(editing.id,{date:new Date(e.target.value).toISOString()});setEditing({...editing,date:new Date(e.target.value).toISOString()})}} style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',color:'var(--text-primary)'}}/></div><div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>CATEGORY</label><div style={{display:'flex',gap:8,flexWrap:'wrap'}}>{data.categories.map(c=><button key={c} onClick={()=>{updatePhoto(editing.id,{category:c});setEditing({...editing,category:c})}} style={{padding:'8px 14px',borderRadius:'var(--radius-md)',background:editing.category===c?'var(--accent-primary)':'var(--bg-input)',color:editing.category===c?'var(--bg-deep)':'var(--text-primary)',fontSize:13}}>{c}</button>)}</div></div><button onClick={()=>delPhoto(editing.id)} style={{width:'100%',padding:12,background:'rgba(231,111,81,0.2)',borderRadius:'var(--radius-md)',color:'#e76f51',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}><Icons.Trash/> Delete</button></div>}</Modal>
          <Modal isOpen={showTimeline} onClose={()=>setShowTimeline(false)} title="Timeline Grid" full><TimelineGrid photos={photos}/></Modal>
          <Modal isOpen={showAddCat} onClose={()=>setShowAddCat(false)} title="Add Category"><input type="text" value={newCat} onChange={e=>setNewCat(e.target.value)} placeholder="Category name..." style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',marginBottom:16,color:'var(--text-primary)'}}/><button onClick={addCat} style={{width:'100%',padding:14,background:'var(--accent-primary)',borderRadius:'var(--radius-md)',color:'var(--bg-deep)',fontWeight:500}}>Add</button></Modal>
        </div>
      );
    };

    // Meds Tab
    const MedsTab=({data,setData})=>{
      const[showAdd,setShowAdd]=useState(false);
      const[showLog,setShowLog]=useState(false);
      const[selMed,setSelMed]=useState(null);
      const[newMed,setNewMed]=useState({name:'',type:'injection',dose:'',frequency:''});
      const[log,setLog]=useState({dose:'',site:'',notes:'',date:fmtDateInput(new Date())});
      const sites=['Left Thigh','Right Thigh','Left Glute','Right Glute','Left Deltoid','Right Deltoid','Abdomen'];
      const getLast=id=>{const l=data.medLogs.filter(x=>x.medicationId===id);return l.length?l.sort((a,b)=>new Date(b.date)-new Date(a.date))[0]:null};
      const getLastSite=id=>{const l=data.medLogs.filter(x=>x.medicationId===id&&x.site);return l.length?l.sort((a,b)=>new Date(b.date)-new Date(a.date))[0]?.site:null};
      const getSuggested=id=>{const ls=getLastSite(id);if(!ls)return sites[0];return sites[(sites.indexOf(ls)+1)%sites.length]};
      const addMed=()=>{if(!newMed.name.trim())return;setData(p=>({...p,medications:[...p.medications,{id:gid(),...newMed}]}));setNewMed({name:'',type:'injection',dose:'',frequency:''});setShowAdd(false)};
      const logDose=()=>{if(!selMed)return;setData(p=>({...p,medLogs:[...p.medLogs,{id:gid(),medicationId:selMed.id,dose:log.dose||selMed.dose,site:log.site,notes:log.notes,date:new Date(log.date).toISOString()}]}));setLog({dose:'',site:'',notes:'',date:fmtDateInput(new Date())});setShowLog(false);setSelMed(null)};
      return(
        <div className="fade-in">
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}><h2 style={{fontFamily:'var(--font-display)',fontSize:20,fontWeight:500}}>Medications</h2><button onClick={()=>setShowAdd(true)} style={{padding:'10px 16px',background:'var(--accent-primary)',borderRadius:'var(--radius-md)',color:'var(--bg-deep)',fontWeight:500,display:'flex',alignItems:'center',gap:6,fontSize:14}}><Icons.Plus/> Add</button></div>
          {data.medications.length===0?<div style={{textAlign:'center',padding:60,color:'var(--text-muted)'}}><div style={{fontSize:48,marginBottom:16}}>ðŸ’Š</div><p>No medications yet</p></div>:<div style={{display:'flex',flexDirection:'column',gap:12}}>{data.medications.map(m=>{const last=getLast(m.id),days=last?daysBetween(last.date,new Date()):null;return<div key={m.id} style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:20}}><div style={{marginBottom:12}}><h3 style={{fontSize:18,fontWeight:500,marginBottom:4}}>{m.name}</h3><p style={{fontSize:13,color:'var(--text-muted)'}}>{m.type} â€¢ {m.dose} â€¢ {m.frequency}</p></div>{last&&<div style={{padding:12,background:'var(--bg-input)',borderRadius:'var(--radius-md)',marginBottom:12,fontSize:13}}><div style={{color:'var(--text-muted)',marginBottom:4}}>Last dose</div><div>{fmtDate(last.date)} ({days===0?'Today':`${days}d ago`})</div>{last.site&&<div style={{color:'var(--text-muted)',marginTop:4}}>Site: {last.site}</div>}</div>}<button onClick={()=>{setSelMed(m);setLog({dose:m.dose,site:m.type==='injection'?getSuggested(m.id):'',notes:'',date:fmtDateInput(new Date())});setShowLog(true)}} style={{width:'100%',padding:12,background:'var(--accent-success)',borderRadius:'var(--radius-md)',color:'var(--bg-deep)',fontWeight:500,display:'flex',alignItems:'center',justifyContent:'center',gap:8}}><Icons.Check/> Log Dose</button></div>})}</div>}
          <Modal isOpen={showAdd} onClose={()=>setShowAdd(false)} title="Add Medication"><div style={{display:'flex',flexDirection:'column',gap:16}}><div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>NAME</label><input type="text" value={newMed.name} onChange={e=>setNewMed({...newMed,name:e.target.value})} placeholder="e.g., Estradiol" style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',color:'var(--text-primary)'}}/></div><div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>TYPE</label><div style={{display:'flex',gap:8,flexWrap:'wrap'}}>{['injection','patch','pill','gel','other'].map(t=><button key={t} onClick={()=>setNewMed({...newMed,type:t})} style={{padding:'8px 14px',borderRadius:'var(--radius-md)',background:newMed.type===t?'var(--accent-primary)':'var(--bg-input)',color:newMed.type===t?'var(--bg-deep)':'var(--text-primary)',fontSize:13,textTransform:'capitalize'}}>{t}</button>)}</div></div><div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>DOSE</label><input type="text" value={newMed.dose} onChange={e=>setNewMed({...newMed,dose:e.target.value})} placeholder="e.g., 5mg" style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',color:'var(--text-primary)'}}/></div><div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>FREQUENCY</label><input type="text" value={newMed.frequency} onChange={e=>setNewMed({...newMed,frequency:e.target.value})} placeholder="e.g., Weekly" style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',color:'var(--text-primary)'}}/></div><button onClick={addMed} style={{width:'100%',padding:14,background:'var(--accent-primary)',borderRadius:'var(--radius-md)',color:'var(--bg-deep)',fontWeight:500,marginTop:8}}>Add</button></div></Modal>
          <Modal isOpen={showLog} onClose={()=>{setShowLog(false);setSelMed(null)}} title={`Log ${selMed?.name||''}`}><div style={{display:'flex',flexDirection:'column',gap:16}}><div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>DATE</label><input type="date" value={log.date} onChange={e=>setLog({...log,date:e.target.value})} style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',color:'var(--text-primary)'}}/></div><div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>DOSE</label><input type="text" value={log.dose} onChange={e=>setLog({...log,dose:e.target.value})} style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',color:'var(--text-primary)'}}/></div>{selMed?.type==='injection'&&<div><label style={{fontSize:12,color:'var(--text-muted)',display:'block',marginBottom:6}}>SITE {getLastSite(selMed.id)&&<span style={{color:'var(--accent-warm)'}}>(Last: {getLastSite(selMed.id)})</span>}</label><div style={{display:'flex',flexWrap:'wrap',gap:8}}>{sites.map(s=><button key={s} onClick={()=>setLog({...log,site:s})} style={{padding:'8px 12px',borderRadius:'var(--radius-md)',background:log.site===s?'var(--accent-primary)':'var(--bg-input)',color:log.site===s?'var(--bg-deep)':'var(--text-primary)',fontSize:13}}>{s}</button>)}</div></div>}<button onClick={logDose} style={{width:'100%',padding:14,background:'var(--accent-success)',borderRadius:'var(--radius-md)',color:'var(--bg-deep)',fontWeight:500,marginTop:8}}>Log</button></div></Modal>
        </div>
      );
    };

    // Settings Tab
    const SettingsTab=({data,setData,onStealth,hasPin,onSetupPin,onRemovePin})=>{
      const exp=()=>{const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`chrysalis-${dateKey(new Date())}.json`;a.click()};
      const imp=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{if(confirm('Replace all data?')){setData(JSON.parse(ev.target.result));alert('Imported!')}}catch{alert('Invalid file')}};r.readAsText(f)};
      const st={photos:data.photos.length,journals:data.journals.length,medLogs:data.medLogs.length,tags:data.tagLogs.length};
      return(
        <div className="fade-in">
          <h2 style={{fontFamily:'var(--font-display)',fontSize:20,fontWeight:500,marginBottom:24}}>Settings</h2>
          <div style={{background:'linear-gradient(135deg,var(--bg-card),#2a2440)',borderRadius:'var(--radius-lg)',padding:24,marginBottom:24,border:'1px solid var(--border-subtle)'}}><div style={{fontSize:12,color:'var(--text-muted)',marginBottom:16}}>YOUR JOURNEY</div><div style={{display:'grid',gridTemplateColumns:'repeat(2, 1fr)',gap:16}}><div><div style={{fontSize:28,fontFamily:'var(--font-display)',fontWeight:300}}>{st.photos}</div><div style={{fontSize:12,color:'var(--text-muted)'}}>Photos</div></div><div><div style={{fontSize:28,fontFamily:'var(--font-display)',fontWeight:300}}>{st.journals}</div><div style={{fontSize:12,color:'var(--text-muted)'}}>Journal</div></div><div><div style={{fontSize:28,fontFamily:'var(--font-display)',fontWeight:300}}>{st.medLogs}</div><div style={{fontSize:12,color:'var(--text-muted)'}}>Doses</div></div><div><div style={{fontSize:28,fontFamily:'var(--font-display)',fontWeight:300}}>{st.tags}</div><div style={{fontSize:12,color:'var(--text-muted)'}}>Tag Logs</div></div></div></div>
          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:20,marginBottom:16}}><div style={{fontSize:12,color:'var(--text-muted)',marginBottom:16}}>SECURITY</div><button onClick={()=>hasPin?onRemovePin():onSetupPin()} style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}><span style={{display:'flex',alignItems:'center',gap:12}}><Icons.Lock/>PIN Lock</span><span style={{color:hasPin?'var(--accent-success)':'var(--text-muted)',fontSize:14}}>{hasPin?'Enabled':'Disabled'}</span></button><button onClick={onStealth} style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',display:'flex',alignItems:'center',justifyContent:'space-between'}}><span style={{display:'flex',alignItems:'center',gap:12}}>ðŸš‚ Stealth Mode</span><span style={{color:'var(--text-muted)',fontSize:14}}>Test</span></button></div>
          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:20,marginBottom:16}}><div style={{fontSize:12,color:'var(--text-muted)',marginBottom:16}}>DATA</div><button onClick={exp} style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',display:'flex',alignItems:'center',gap:12,marginBottom:12}}><Icons.Download/>Export Backup</button><label style={{width:'100%',padding:14,background:'var(--bg-input)',borderRadius:'var(--radius-md)',display:'flex',alignItems:'center',gap:12,cursor:'pointer'}}><Icons.Upload/>Import Backup<input type="file" accept=".json" onChange={imp} style={{display:'none'}}/></label></div>
          <div style={{background:'var(--bg-card)',borderRadius:'var(--radius-lg)',padding:20}}><div style={{fontSize:12,color:'#e76f51',marginBottom:16}}>DANGER ZONE</div><button onClick={()=>{if(confirm('Delete ALL data?')){localStorage.removeItem(STORE);localStorage.removeItem(PIN_KEY);window.location.reload()}}} style={{width:'100%',padding:14,background:'rgba(231,111,81,0.15)',borderRadius:'var(--radius-md)',color:'#e76f51',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}><Icons.Trash/>Delete All Data</button></div>
          <div style={{textAlign:'center',padding:32,color:'var(--text-muted)',fontSize:12}}><div style={{fontSize:24,marginBottom:8}}>ðŸ¦‹</div><div style={{fontFamily:'var(--font-display)',fontSize:16,marginBottom:4}}>Chrysalis v2</div><div>Your journey, your way</div></div>
        </div>
      );
    };

    // Main App
    const App=()=>{
      const[data,setData]=useState(load);
      const[tab,setTab]=useState('calendar');
      const[selDate,setSelDate]=useState(null);
      const[locked,setLocked]=useState(!!localStorage.getItem(PIN_KEY));
      const[pinSetup,setPinSetup]=useState(false);
      const[stealth,setStealth]=useState(false);
      const[,forceUpdate]=useState(0);
      useEffect(()=>{save(data)},[data]);

      if(stealth)return<Stealth onExit={()=>setStealth(false)}/>;
      if(locked)return<PinLock onUnlock={()=>setLocked(false)} isSetup={false}/>;
      if(pinSetup)return<PinLock isSetup onComplete={()=>{setPinSetup(false);forceUpdate(n=>n+1)}}/>;

      const hasPin=!!localStorage.getItem(PIN_KEY);
      const removePin=()=>{if(confirm('Remove PIN lock?')){localStorage.removeItem(PIN_KEY);forceUpdate(n=>n+1)}};

      const tabs=[{id:'calendar',icon:Icons.Calendar,label:'Calendar'},{id:'photos',icon:Icons.Camera,label:'Photos'},{id:'meds',icon:Icons.Pill,label:'Meds'},{id:'chart',icon:Icons.Chart,label:'Track'},{id:'settings',icon:Icons.Settings,label:'Settings'}];
      return(
        <div style={{height:'100%',display:'flex',flexDirection:'column',background:'var(--bg-deep)'}}>
          <header style={{padding:'16px 20px',paddingTop:'calc(16px + var(--safe-top))',borderBottom:'1px solid var(--border-subtle)',display:'flex',alignItems:'center',gap:12}}><span style={{fontSize:24}}>ðŸ¦‹</span><h1 style={{fontFamily:'var(--font-display)',fontSize:22,fontWeight:400}}>Chrysalis</h1></header>
          <main style={{flex:1,overflow:'auto',padding:20}}>
            {tab==='calendar'&&!selDate&&<CalendarView data={data} onDateSelect={setSelDate}/>}
            {tab==='calendar'&&selDate&&<DayDetail date={selDate} data={data} setData={setData} onClose={()=>setSelDate(null)}/>}
            {tab==='photos'&&<PhotosTab data={data} setData={setData}/>}
            {tab==='meds'&&<MedsTab data={data} setData={setData}/>}
            {tab==='chart'&&<TrackingChart data={data}/>}
            {tab==='settings'&&<SettingsTab data={data} setData={setData} onStealth={()=>setStealth(true)} hasPin={hasPin} onSetupPin={()=>setPinSetup(true)} onRemovePin={removePin}/>}
          </main>
          <nav style={{display:'flex',borderTop:'1px solid var(--border-subtle)',paddingBottom:'var(--safe-bottom)',background:'var(--bg-card)'}}>{tabs.map(t=>{const I=t.icon,a=tab===t.id;return<button key={t.id} onClick={()=>{setTab(t.id);if(t.id==='calendar')setSelDate(null)}} style={{flex:1,padding:'12px 0',display:'flex',flexDirection:'column',alignItems:'center',gap:4,color:a?'var(--accent-primary)':'var(--text-muted)'}}><I/><span style={{fontSize:10,fontWeight:500}}>{t.label}</span></button>})}</nav>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
